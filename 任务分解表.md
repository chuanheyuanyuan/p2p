# 任务分解表

## 说明

**任务粒度**：每个任务可在1-3小时内完成，涉及1-3个文件改动，提交一个可运行的增量（含测试）

**依赖关系**：任务ID格式为 `[Epic]-[序号]`，依赖项指向前置任务ID

**验收标准（DoD）**：每个任务必须满足所有DoD条件才算完成

---

## Epic A：基础设施与DevOps

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| A-1 | Monorepo骨架搭建 | 初始化pnpm workspace，创建services/apps目录结构 | 无 | - 根目录pnpm-workspace.yaml<br>- package.json<br>- tsconfig.json<br>- .gitignore<br>- README.md | 无 | - pnpm install成功<br>- pnpm list显示workspace | - 所有packages可被识别<br>- 共享依赖配置正确<br>- TypeScript编译配置有效 | - [ ] pnpm install零错误<br>- [ ] workspace结构正确<br>- [ ] README包含快速开始 | `/pnpm-workspace.yaml`<br>`/package.json`<br>`/README.md` |
| A-2 | 日志与错误码中间件 | 实现统一日志（Winston/Pino）与错误码规范 | A-1 | - `packages/common/logger.ts`<br>- `packages/common/error-codes.ts`<br>- `packages/common/exceptions.ts` | - `logger.info/warn/error()`<br>- `BusinessException(code, msg)` | - 日志输出JSON格式<br>- 错误码符合规范 | - 日志包含traceId<br>- 错误响应统一格式<br>- 敏感信息脱敏 | - [ ] 日志JSON可解析<br>- [ ] 错误码符合[模块][状态码][序号]<br>- [ ] 手机号/证件号已脱敏 | `/packages/common/src/` |
| A-3 | PostgreSQL与TypeORM配置 | 配置数据库连接与迁移脚本 | A-1, A-2 | - `packages/database/ormconfig.ts`<br>- `packages/database/migrations/`<br>- `.env.example` | - DataSource导出<br>- 迁移命令 | - 连接成功<br>- 迁移执行成功 | - 支持多环境配置<br>- 迁移可回滚<br>- 连接池配置合理 | - [ ] 本地连接成功<br>- [ ] 迁移脚本可运行<br>- [ ] 敏感信息走环境变量 | `/packages/database/` |
| A-4 | Redis配置与工具类 | 配置Redis连接，封装缓存/锁工具 | A-1, A-2 | - `packages/cache/redis.config.ts`<br>- `packages/cache/cache.service.ts`<br>- `packages/cache/lock.service.ts` | - `cache.get/set/del()`<br>- `lock.acquire/release()` | - Redis读写成功<br>- 分布式锁互斥正常 | - 支持序列化/反序列化<br>- 锁超时释放<br>- 连接失败降级 | - [ ] Redis连接正常<br>- [ ] 分布式锁测试通过<br>- [ ] 缓存过期生效 | `/packages/cache/` |
| A-5 | Kafka事件总线封装 | 配置Kafka，封装producer/consumer SDK | A-1, A-2 | - `packages/event-bus/kafka.config.ts`<br>- `packages/event-bus/producer.ts`<br>- `packages/event-bus/consumer.ts`<br>- `packages/event-bus/events.ts`（事件定义） | - `emit(event, payload)`<br>- `subscribe(topic, handler)` | - 发送/接收事件成功<br>- 消息幂等性 | - 事件Schema标准化<br>- 支持重试<br>- Dead Letter Queue | - [ ] 事件发送成功<br>- [ ] 消费者收到消息<br>- [ ] 幂等性验证通过 | `/packages/event-bus/` |
| A-6 | API网关（Kong）配置 | 配置Kong网关，路由到各服务 | A-1 | - `infra/kong/kong.yml`<br>- `infra/kong/plugins/`（JWT/限流） | - `/api/* → 上游服务` | - 路由正确<br>- JWT验证生效 | - 限流策略生效<br>- CORS配置正确<br>- 健康检查正常 | - [ ] 路由配置正确<br>- [ ] JWT插件生效<br>- [ ] 限流测试通过 | `/infra/kong/` |
| A-7 | Docker Compose本地环境 | 编写Docker Compose，一键启动所有依赖 | A-3, A-4, A-5, A-6 | - `docker-compose.yml`<br>- `docker-compose.override.yml`（本地覆盖） | 无 | - `docker compose up`成功<br>- 所有服务健康 | - PostgreSQL/Redis/Kafka/Kong全启动<br>- 数据持久化<br>- 日志可查看 | - [ ] 所有容器Running<br>- [ ] 服务间网络互通<br>- [ ] 数据卷挂载正确 | `/docker-compose.yml` |
| A-8 | CI/CD Pipeline基础 | 配置GitHub Actions：lint/test/build | A-1 | - `.github/workflows/ci.yml`<br>- `.github/workflows/cd-dev.yml` | 无 | - PR触发CI<br>- Lint/Test通过 | - ESLint/Prettier通过<br>- 单元测试覆盖率≥70%<br>- 镜像构建成功 | - [ ] CI自动触发<br>- [ ] 测试覆盖率达标<br>- [ ] 镜像推送成功 | `/.github/workflows/` |
| A-9 | MinIO对象存储配置 | 配置MinIO（S3兼容），封装上传工具 | A-1, A-2 | - `packages/storage/minio.config.ts`<br>- `packages/storage/upload.service.ts` | - `upload(file, bucket)`<br>- `getSignedUrl(key)` | - 上传/下载成功<br>- 签名URL有效 | - 支持分片上传<br>- 文件类型校验<br>- 安全策略配置 | - [ ] 文件上传成功<br>- [ ] 预签名URL可访问<br>- [ ] Bucket权限正确 | `/packages/storage/` |

---

## Epic B：认证与用户域

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| B-1 | 用户表与设备表DDL | 创建user/device_profile/kyc/contacts表 | A-3 | - `migrations/001_create_user_tables.ts` | 无（数据库Schema） | - 迁移执行成功<br>- 索引创建正确 | - 主键/外键约束<br>- 索引覆盖查询<br>- 字段类型/长度合理 | - [ ] 迁移执行成功<br>- [ ] 回滚脚本测试通过<br>- [ ] EXPLAIN查询使用索引 | `/migrations/001_*.ts` |
| B-2 | auth-svc：OTP发送 | 实现OTP发送接口，限流保护 | A-2, A-4, B-1 | - `services/auth-svc/src/otp.controller.ts`<br>- `services/auth-svc/src/otp.service.ts`<br>- `services/auth-svc/src/sms.service.ts`（stub） | `POST /auth/send-otp`<br>请求：`{phone}`<br>响应：`{requestId, expiresIn}` | - OTP生成正确<br>- Redis存储成功<br>- 限流生效 | - 60s倒计时<br>- 日内限制10次<br>- 手机号格式校验 | - [ ] OTP 6位数字<br>- [ ] Redis TTL正确<br>- [ ] 限流返回429 | `/services/auth-svc/src/otp.*` |
| B-3 | auth-svc：OTP登录与JWT | 实现OTP验证与JWT签发 | B-2 | - `services/auth-svc/src/auth.controller.ts`<br>- `services/auth-svc/src/auth.service.ts`<br>- `services/auth-svc/src/jwt.strategy.ts` | `POST /auth/login`<br>请求：`{phone, otp, deviceInfo}`<br>响应：`{accessToken, refreshToken, user}` | - OTP验证正确<br>- JWT签发成功<br>- 重放保护 | - JWT包含userId/role<br>- AccessToken 15min<br>- RefreshToken 7天 | - [ ] OTP错误返回A40002<br>- [ ] JWT可解析<br>- [ ] 重放返回40901 | `/services/auth-svc/src/auth.*` |
| B-4 | user-svc：用户注册 | 创建用户记录，发布USER_REGISTERED事件 | A-5, B-1, B-3 | - `services/user-svc/src/user.controller.ts`<br>- `services/user-svc/src/user.service.ts`<br>- `services/user-svc/src/user.entity.ts` | `POST /user/register`（内部调用）<br>请求：`{phone, country}`<br>响应：`{userId}` | - 用户创建成功<br>- 事件发布成功 | - 手机号唯一索引<br>- 初始level=LEVEL1<br>- 事件包含userId/phone | - [ ] 重复注册返回错误<br>- [ ] USER_REGISTERED事件已发<br>- [ ] 用户ID为UUID | `/services/user-svc/src/user.*` |
| B-5 | user-svc：设备指纹上报 | 记录设备信息，检测模拟器/Root | B-4 | - `services/user-svc/src/device.controller.ts`<br>- `services/user-svc/src/device.service.ts`<br>- `services/user-svc/src/device.entity.ts` | `POST /user/devices`<br>请求：`{deviceId, brand, model, isEmulator, isRoot, ...}`<br>响应：`{success}` | - 设备信息保存<br>- 模拟器检测 | - 多设备关联用户<br>- 设备指纹唯一索引<br>- 异常设备标记 | - [ ] 设备信息入库<br>- [ ] isEmulator正确识别<br>- [ ] 设备更换检测 | `/services/user-svc/src/device.*` |
| B-6 | user-svc：KYC OCR上传 | 上传证件图片，调用OCR（stub），保存结果 | A-9, B-4 | - `services/user-svc/src/kyc.controller.ts`<br>- `services/user-svc/src/kyc.service.ts`<br>- `services/user-svc/src/ocr.stub.ts` | `POST /kyc/ocr`<br>请求：multipart（frontImage, backImage, idType）<br>响应：`{idNumber, name, birthday}` | - 图片上传MinIO<br>- OCR stub返回<br>- KYC记录创建 | - 图片大小/格式校验<br>- OCR结果保存<br>- 状态=OCR_PROCESSING | - [ ] 图片URL可访问<br>- [ ] OCR结果入库<br>- [ ] KYC状态更新 | `/services/user-svc/src/kyc.*`<br>`/services/user-svc/src/ocr.stub.ts` |
| B-7 | user-svc：KYC活体检测 | 上传活体视频，调用检测（stub），更新KYC状态 | B-6 | - `services/user-svc/src/liveness.controller.ts`<br>- `services/user-svc/src/liveness.service.ts`<br>- `services/user-svc/src/liveness.stub.ts` | `POST /kyc/liveness`<br>请求：multipart（video）<br>响应：`{passed, score}` | - 视频上传MinIO<br>- 活体stub返回<br>- KYC状态更新 | - 视频大小限制<br>- 活体分数≥0.8通过<br>- 发布KYC_PASSED/FAILED事件 | - [ ] 视频URL可访问<br>- [ ] 活体分数计算正确<br>- [ ] KYC事件已发布 | `/services/user-svc/src/liveness.*` |
| B-8 | user-svc：用户资料更新 | 更新用户基本信息（地址/职业/联系人） | B-4 | - `services/user-svc/src/profile.controller.ts`<br>- `services/user-svc/src/profile.service.ts`<br>- `services/user-svc/src/contact.entity.ts` | `PUT /user/profile`<br>`POST /user/contacts`<br>请求：`{address, occupation, contacts[]}` | - 资料更新成功<br>- 联系人保存 | - 必填字段校验<br>- 联系人2-3个<br>- 地理位置保存 | - [ ] 资料更新入库<br>- [ ] 联系人数量校验<br>- [ ] 地理位置格式正确 | `/services/user-svc/src/profile.*` |
| B-9 | bff-mobile：用户信息聚合 | 聚合用户/KYC/设备信息，提供单一接口 | B-4, B-5, B-6, B-7 | - `apps/bff-mobile/src/user.controller.ts`<br>- `apps/bff-mobile/src/user.service.ts` | `GET /bff/mobile/user/profile`<br>响应：`{user, kyc, devices, level}` | - 单接口返回完整信息<br>- P95 ≤ 200ms | - 并发调用user-svc<br>- 缓存1分钟<br>- 错误降级 | - [ ] 响应时间达标<br>- [ ] 缓存生效<br>- [ ] 降级返回部分数据 | `/apps/bff-mobile/src/user.*` |

---

## Epic C：风控域

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| C-1 | 风控表DDL | 创建规则/策略/黑名单/评估日志表 | A-3 | - `migrations/002_create_risk_tables.ts` | 无（数据库Schema） | - 迁移执行成功<br>- 索引覆盖查询 | - rule/strategy/blacklist表<br>- risk_log保留快照<br>- 联合索引优化 | - [ ] 迁移执行成功<br>- [ ] 查询性能测试通过<br>- [ ] 回滚脚本验证 | `/migrations/002_*.ts` |
| C-2 | risk-svc：规则引擎MVP | 实现DSL规则解析器（IF/ELSE/AND/OR） | C-1 | - `services/risk-svc/src/rule-engine.ts`<br>- `services/risk-svc/src/rule.entity.ts`<br>- `services/risk-svc/src/dsl-parser.ts` | 内部调用：`evaluateRules(context)` → `{matched[], score}` | - 规则解析正确<br>- 命中逻辑准确 | - 支持嵌套条件<br>- 规则优先级<br>- 性能<100ms | - [ ] 3-5条规则测试通过<br>- [ ] 嵌套规则解析正确<br>- [ ] 规则缓存生效 | `/services/risk-svc/src/rule-engine.ts` |
| C-3 | risk-svc：黑名单检查 | 实现黑名单检查（手机号/设备/IP） | C-1, C-2 | - `services/risk-svc/src/blacklist.service.ts`<br>- `services/risk-svc/src/blacklist.entity.ts` | 内部调用：`checkBlacklist(phone, deviceId, ip)` → `{hit, reason}` | - 黑名单命中准确<br>- 查询性能 | - 支持模糊匹配<br>- 黑名单过期<br>- 白名单优先 | - [ ] 黑名单命中返回R42201<br>- [ ] 白名单豁免生效<br>- [ ] 过期自动失效 | `/services/risk-svc/src/blacklist.*` |
| C-4 | risk-svc：评分卡 | 实现简单评分卡（5个维度加权） | C-2 | - `services/risk-svc/src/scoring.service.ts`<br>- `services/risk-svc/src/scorecard.entity.ts` | 内部调用：`calculateScore(user, device, kyc)` → `{score}` | - 评分计算正确<br>- 0-1000分 | - KYC/设备/历史/渠道/资料维度<br>- 权重可配置<br>- 评分快照保存 | - [ ] 评分范围正确<br>- [ ] 权重加总=1<br>- [ ] 评分日志入库 | `/services/risk-svc/src/scoring.*` |
| C-5 | risk-svc：风控决策API | 对外提供决策接口，整合规则/黑名单/评分 | C-2, C-3, C-4 | - `services/risk-svc/src/risk.controller.ts`<br>- `services/risk-svc/src/risk.service.ts` | `POST /risk/evaluate`<br>请求：`{userId, loanCandidate, signals}`<br>响应：`{decision, score, reasons[]}` | - 决策逻辑正确<br>- 可解释性 | - APPROVE/REJECT/MANUAL<br>- reasons数组包含命中规则<br>- 决策日志保存 | - [ ] 决策结果符合规则<br>- [ ] reasons可追溯<br>- [ ] 日志完整 | `/services/risk-svc/src/risk.*` |
| C-6 | risk-svc：策略包与等级映射 | 配置Level1-5与额度/期限/费率映射 | C-5 | - `services/risk-svc/src/strategy.service.ts`<br>- `services/risk-svc/src/strategy.entity.ts` | `GET /risk/strategy/{level}` → `{amountRange, termOptions, feeRate}` | - 策略读取正确<br>- 缓存生效 | - 5个等级配置<br>- 额度/期限/费率可调<br>- 策略版本化 | - [ ] 策略配置入库<br>- [ ] 等级映射正确<br>- [ ] 缓存失效及时 | `/services/risk-svc/src/strategy.*` |

---

## Epic D：贷款域

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| D-1 | 贷款表DDL | 创建loan/loan_offer/loan_audit/contract/loan_event表 | A-3 | - `migrations/003_create_loan_tables.ts` | 无（数据库Schema） | - 迁移执行成功<br>- 金额字段DECIMAL(18,2) | - 状态机字段枚举<br>- 联合索引（userId+status）<br>- loan_event事件日志 | - [ ] 迁移执行成功<br>- [ ] 金额精度正确<br>- [ ] 索引覆盖查询 | `/migrations/003_*.ts` |
| D-2 | loan-svc：产品配置 | 定义产品与费率模板（JSON配置） | D-1 | - `services/loan-svc/src/product.entity.ts`<br>- `services/loan-svc/src/product.service.ts`<br>- `services/loan-svc/src/fee-calculator.ts` | `GET /loan/products` → `[{id, name, amountRange, termOptions, feePlan}]` | - 产品列表返回<br>- 费用计算正确 | - 3个产品档位<br>- 费用=利息+服务费+税费<br>- APR披露 | - [ ] 产品配置加载<br>- [ ] 费用计算验证<br>- [ ] APR披露符合公式 | `/services/loan-svc/src/product.*`<br>`/services/loan-svc/src/fee-calculator.ts` |
| D-3 | loan-svc：申请创建 | 创建贷款申请，状态=SUBMITTED | D-1, D-2 | - `services/loan-svc/src/loan.controller.ts`<br>- `services/loan-svc/src/loan.service.ts`<br>- `services/loan-svc/src/loan.entity.ts` | `POST /loan/apply`<br>请求：`{productId, amount, termDays, accountId}`<br>响应：`{loanId, status}` | - 贷款记录创建<br>- 状态=SUBMITTED<br>- 幂等性 | - 幂等键X-Idempotency-Key<br>- 金额/期限校验<br>- 发布LOAN_APPLIED事件 | - [ ] 贷款编号生成<br>- [ ] 幂等键去重<br>- [ ] 事件已发布 | `/services/loan-svc/src/loan.*` |
| D-4 | loan-svc：机审集成 | 调用risk-svc，根据决策更新状态 | D-3, C-5 | - `services/loan-svc/src/auto-review.service.ts`<br>- `services/loan-svc/src/loan-audit.entity.ts` | 内部流程（监听LOAN_APPLIED事件） | - 调用risk-svc成功<br>- 状态迁移正确 | - APPROVE→AUTO_APPROVED<br>- REJECT→AUTO_REJECTED<br>- MANUAL→MANUAL_REVIEW<br>- 审批记录保存 | - [ ] risk-svc调用成功<br>- [ ] 状态正确迁移<br>- [ ] 审批日志完整 | `/services/loan-svc/src/auto-review.*` |
| D-5 | loan-svc：人工审批接口 | 提供人工审批接口（通过/拒绝） | D-4 | - `services/loan-svc/src/manual-review.controller.ts`<br>- `services/loan-svc/src/manual-review.service.ts` | `POST /admin/loan/{loanId}/manual-review`<br>请求：`{result, reasonCode, remark}`<br>响应：`{success}` | - 审批记录保存<br>- 状态更新<br>- 权限校验 | - 审批员ID记录<br>- 审批时间戳<br>- 发布LOAN_APPROVED/REJECTED事件 | - [ ] 审批记录入库<br>- [ ] 状态迁移正确<br>- [ ] 事件已发布 | `/services/loan-svc/src/manual-review.*` |
| D-6 | loan-svc：合同生成（stub） | 生成合同PDF（简单模板），上传MinIO | D-5 | - `services/loan-svc/src/contract.service.ts`<br>- `services/loan-svc/src/contract-template.html` | `POST /loan/{loanId}/contract/generate`（内部调用）<br>响应：`{fileUrl}` | - PDF生成成功<br>- 上传MinIO成功 | - 合同包含借款要素<br>- PDF可下载<br>- 签署状态=UNSIGNED | - [ ] PDF渲染正确<br>- [ ] MinIO URL有效<br>- [ ] 合同记录入库 | `/services/loan-svc/src/contract.*` |
| D-7 | loan-svc：合同签署 | 用户签署合同（勾选+OTP验证） | D-6 | - `services/loan-svc/src/sign.controller.ts`<br>- `services/loan-svc/src/sign.service.ts` | `POST /loan/{loanId}/sign`<br>请求：`{signature, otp}`<br>响应：`{success}` | - OTP验证<br>- 签署记录<br>- 状态=APPROVED | - 签署时间戳<br>- OTP调用auth-svc<br>- 签署后触发放款 | - [ ] OTP验证通过<br>- [ ] 签署状态更新<br>- [ ] 触发放款流程 | `/services/loan-svc/src/sign.*` |
| D-8 | loan-svc：贷款详情聚合 | 聚合贷款/合同/账单/进度信息 | D-3, D-6 | - `services/loan-svc/src/loan-detail.controller.ts`<br>- `services/loan-svc/src/loan-detail.service.ts` | `GET /loan/{loanId}` → `{loan, contract, bill, timeline}` | - 详情完整<br>- P95 ≤ 300ms | - timeline包含所有状态迁移<br>- 缓存5分钟<br>- 敏感信息脱敏 | - [ ] 响应时间达标<br>- [ ] timeline正确<br>- [ ] 脱敏生效 | `/services/loan-svc/src/loan-detail.*` |

---

## Epic E：资金与支付

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| E-1 | 支付表DDL | 创建disbursement/repayment/payment_channel表 | A-3 | - `migrations/004_create_payment_tables.ts` | 无（数据库Schema） | - 迁移执行成功<br>- 唯一索引（reqNo） | - 支付状态枚举<br>- 通道配置JSON<br>- 回调幂等键 | - [ ] 迁移执行成功<br>- [ ] reqNo唯一<br>- [ ] 金额精度正确 | `/migrations/004_*.ts` |
| E-2 | payment-svc：通道抽象层 | 定义通道接口，实现沙箱stub | E-1 | - `services/payment-svc/src/channel/channel.interface.ts`<br>- `services/payment-svc/src/channel/sandbox.channel.ts` | 内部接口：`disburse(order)` → `{status, channelOrderNo}` | - 沙箱模拟成功/失败 | - 支持多通道<br>- 通道路由策略<br>- 错误码映射 | - [ ] 沙箱返回成功<br>- [ ] 沙箱模拟失败<br>- [ ] 错误码正确 | `/services/payment-svc/src/channel/` |
| E-3 | payment-svc：放款接口 | 实现放款接口，调用通道，保存记录 | E-2, D-7 | - `services/payment-svc/src/disburse.controller.ts`<br>- `services/payment-svc/src/disburse.service.ts` | `POST /payment/disburse`<br>请求：`{loanId, amount, account}`<br>响应：`{disbursementId, status}` | - 放款记录保存<br>- 通道调用成功<br>- 幂等性 | - 状态=DISBURSE_PENDING<br>- 幂等键X-Idempotency-Key<br>- 分布式锁防并发 | - [ ] 放款记录入库<br>- [ ] 幂等键去重<br>- [ ] 并发测试通过 | `/services/payment-svc/src/disburse.*` |
| E-4 | payment-svc：回调处理 | 处理通道回调，更新状态，发布事件 | E-3 | - `services/payment-svc/src/callback.controller.ts`<br>- `services/payment-svc/src/callback.service.ts` | `POST /payment/callback`<br>请求：`{channelOrderNo, status, signature}`<br>响应：`{success}` | - 签名验证<br>- 幂等性<br>- 事件发布 | - 签名验证失败拒绝<br>- 重复回调返回成功（幂等）<br>- 发布DISBURSED/DISBURSE_FAILED事件 | - [ ] 签名验证通过<br>- [ ] 幂等性测试通过<br>- [ ] 事件已发布 | `/services/payment-svc/src/callback.*` |
| E-5 | payment-svc：重试与切换通道 | 实现失败重试逻辑（指数退避） | E-3, E-4 | - `services/payment-svc/src/retry.service.ts` | 内部逻辑（定时任务扫描失败订单） | - 重试3次<br>- 切换通道 | - 指数退避（1min/5min/15min）<br>- 切换备用通道<br>- 重试次数限制 | - [ ] 重试任务触发<br>- [ ] 切换通道生效<br>- [ ] 重试上限停止 | `/services/payment-svc/src/retry.*` |
| E-6 | payment-svc：还款接口 | 实现还款接口，生成支付链接/收银台 | E-2 | - `services/payment-svc/src/repay.controller.ts`<br>- `services/payment-svc/src/repay.service.ts` | `POST /payment/pay`<br>请求：`{loanId, amount, channel}`<br>响应：`{paymentUrl}` | - 生成支付链接<br>- 还款记录保存 | - 支持全额/部分还款<br>- 金额校验<br>- 状态=PENDING | - [ ] 支付链接生成<br>- [ ] 还款记录入库<br>- [ ] 金额校验通过 | `/services/payment-svc/src/repay.*` |
| E-7 | payment-svc：还款回调处理 | 处理还款回调，发布REPAYMENT_POSTED事件 | E-6, E-4 | - `services/payment-svc/src/repay-callback.service.ts` | `POST /payment/callback/repay`<br>请求：`{channelOrderNo, status, signature}` | - 签名验证<br>- 幂等性<br>- 事件发布 | - 重复回调幂等<br>- 发布REPAYMENT_POSTED事件<br>- 状态=SUCCESS | - [ ] 签名验证通过<br>- [ ] 幂等性测试通过<br>- [ ] 事件已发布 | `/services/payment-svc/src/repay-callback.*` |

---

## Epic F：账务与账单

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| F-1 | 账务表DDL | 创建ledger_entry/account/balance_snapshot表 | A-3 | - `migrations/005_create_ledger_tables.ts` | 无（数据库Schema） | - 迁移执行成功<br>- 双分录约束 | - 借贷平衡CHECK约束<br>- 科目体系枚举<br>- 余额快照 | - [ ] 迁移执行成功<br>- [ ] 借贷平衡约束生效<br>- [ ] 科目代码完整 | `/migrations/005_*.ts` |
| F-2 | ledger-svc：双分录入账 | 实现双分录入账接口，保证借贷平衡 | F-1 | - `services/ledger-svc/src/ledger.service.ts`<br>- `services/ledger-svc/src/entry.entity.ts` | `POST /ledger/entries`<br>请求：`{ref, lines:[{account, debit, credit}]}`<br>响应：`{success}` | - 借贷平衡<br>- 事务完整性 | - 借贷总额必须相等<br>- 原子性（事务）<br>- 入账幂等 | - [ ] 借贷平衡校验<br>- [ ] 事务回滚测试<br>- [ ] 幂等性验证 | `/services/ledger-svc/src/ledger.*` |
| F-3 | ledger-svc：监听放款事件 | 消费DISBURSED事件，自动入账 | F-2, E-4 | - `services/ledger-svc/src/disbursement.consumer.ts` | 内部逻辑（Kafka消费者） | - 事件消费成功<br>- 入账正确 | - 借:LOAN_PRINCIPAL, 贷:CASH<br>- 消费幂等<br>- 死信队列 | - [ ] 事件消费成功<br>- [ ] 科目正确<br>- [ ] 幂等性验证 | `/services/ledger-svc/src/disbursement.consumer.ts` |
| F-4 | ledger-svc：监听还款事件 | 消费REPAYMENT_POSTED事件，自动入账 | F-2, E-7 | - `services/ledger-svc/src/repayment.consumer.ts` | 内部逻辑（Kafka消费者） | - 事件消费成功<br>- 入账正确 | - 借:CASH, 贷:LOAN_PRINCIPAL/INTEREST<br>- 部分还款拆分<br>- 消费幂等 | - [ ] 事件消费成功<br>- [ ] 科目拆分正确<br>- [ ] 幂等性验证 | `/services/ledger-svc/src/repayment.consumer.ts` |
| F-5 | ledger-svc：余额查询 | 提供账户余额查询接口 | F-2 | - `services/ledger-svc/src/balance.controller.ts`<br>- `services/ledger-svc/src/balance.service.ts` | `GET /ledger/balance?account={accountCode}` → `{balance}` | - 余额计算正确<br>- 查询性能 | - 实时计算（SUM）<br>- 缓存优化<br>- 定期快照 | - [ ] 余额准确<br>- [ ] 查询性能达标<br>- [ ] 快照一致性 | `/services/ledger-svc/src/balance.*` |
| F-6 | loan-svc：账单生成 | 根据产品费率生成账单，到期提醒 | D-2, E-3 | - `services/loan-svc/src/bill.service.ts`<br>- `services/loan-svc/src/bill.entity.ts` | `GET /loan/{loanId}/bill` → `{dueAmount, dueDate, breakdown}` | - 账单计算正确<br>- 费用拆分 | - 应还=本金+利息+服务费+税费<br>- 逾期费计算<br>- 到期日准确 | - [ ] 账单金额验证<br>- [ ] 费用拆分正确<br>- [ ] 到期日准确 | `/services/loan-svc/src/bill.*` |
| F-7 | loan-svc：还款后账单更新 | 监听REPAYMENT_POSTED，更新账单状态 | F-6, E-7 | - `services/loan-svc/src/bill-update.consumer.ts` | 内部逻辑（Kafka消费者） | - 账单更新正确<br>- 状态迁移 | - 全额还款→REPAID<br>- 部分还款→PARTIAL_PAID<br>- 剩余金额计算 | - [ ] 账单状态更新<br>- [ ] 剩余金额正确<br>- [ ] 结清检测准确 | `/services/loan-svc/src/bill-update.consumer.ts` |
| F-8 | loan-svc：展期接口 | 提供展期接口，计算展期费，更新到期日 | F-6 | - `services/loan-svc/src/extend.controller.ts`<br>- `services/loan-svc/src/extend.service.ts` | `POST /loan/{loanId}/extend`<br>请求：`{termDays}`<br>响应：`{newDueDate, extensionFee}` | - 展期费计算<br>- 到期日更新<br>- 次数限制 | - 展期次数≤3<br>- 展期费入账<br>- 发布EXTENDED事件 | - [ ] 展期费正确<br>- [ ] 到期日更新<br>- [ ] 次数限制生效 | `/services/loan-svc/src/extend.*` |

---

## Epic G：通知域

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| G-1 | 通知表DDL | 创建notification_template/notification_log表 | A-3 | - `migrations/006_create_notify_tables.ts` | 无（数据库Schema） | - 迁移执行成功<br>- 模板字段JSON | - 通道类型枚举（SMS/EMAIL/PUSH/WHATSAPP）<br>- 模板变量<br>- 发送日志 | - [ ] 迁移执行成功<br>- [ ] 模板加载<br>- [ ] 日志入库 | `/migrations/006_*.ts` |
| G-2 | notify-svc：短信发送（stub） | 实现短信发送stub，保存日志 | G-1 | - `services/notify-svc/src/sms.service.ts`<br>- `services/notify-svc/src/sms.stub.ts` | `POST /notify/sms`<br>请求：`{phone, template, vars}`<br>响应：`{success}` | - 短信stub返回<br>- 日志保存 | - 模板变量替换<br>- 频率限制<br>- 发送状态记录 | - [ ] 模板渲染正确<br>- [ ] 日志入库<br>- [ ] 限流生效 | `/services/notify-svc/src/sms.*` |
| G-3 | notify-svc：消息模板管理 | 提供模板CRUD接口（后台） | G-1 | - `services/notify-svc/src/template.controller.ts`<br>- `services/notify-svc/src/template.service.ts`<br>- `services/notify-svc/src/template.entity.ts` | `GET/POST/PUT /admin/notify/templates` | - 模板增删改查<br>- 多语言支持 | - 模板版本化<br>- 变量占位符验证<br>- 缓存失效 | - [ ] 模板CRUD成功<br>- [ ] 多语言切换<br>- [ ] 缓存生效 | `/services/notify-svc/src/template.*` |
| G-4 | notify-svc：事件驱动通知 | 监听业务事件，自动发送通知 | G-2, G-3 | - `services/notify-svc/src/event.consumer.ts`<br>- `services/notify-svc/src/notify.service.ts` | 内部逻辑（Kafka消费者） | - 事件消费成功<br>- 通知发送 | - 监听LOAN_APPROVED/DISBURSED/DUE_TODAY等<br>- 模板自动匹配<br>- 失败重试 | - [ ] 事件消费成功<br>- [ ] 通知发送<br>- [ ] 重试机制生效 | `/services/notify-svc/src/event.consumer.ts` |
| G-5 | notify-svc：Push通知（stub） | 实现Push通知stub（FCM/APNS） | G-1 | - `services/notify-svc/src/push.service.ts`<br>- `services/notify-svc/src/push.stub.ts` | `POST /notify/push`<br>请求：`{userId, title, body, data}` | - Push stub返回<br>- 设备token管理 | - 设备token存储<br>- 静默时段控制<br>- 点击跳转配置 | - [ ] Push模拟成功<br>- [ ] 设备token保存<br>- [ ] 静默时段生效 | `/services/notify-svc/src/push.*` |

---

## Epic H：催收域

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| H-1 | 催收表DDL | 创建collection_case/collection_action/ptp/collector表 | A-3 | - `migrations/007_create_collection_tables.ts` | 无（数据库Schema） | - 迁移执行成功<br>- 桶字段枚举 | - bucket枚举（D0/D1/D3/D7/...）<br>- 案件状态枚举<br>- 动作类型枚举 | - [ ] 迁移执行成功<br>- [ ] 枚举完整<br>- [ ] 索引覆盖 | `/migrations/007_*.ts` |
| H-2 | collection-svc：自动建案 | 监听DUE_TODAY/OVERDUE事件，自动创建案件 | H-1, F-6 | - `services/collection-svc/src/case-creation.consumer.ts`<br>- `services/collection-svc/src/case.service.ts` | 内部逻辑（Kafka消费者） | - 事件消费成功<br>- 案件创建 | - DUE_TODAY→bucket=D0<br>- OVERDUE_BUCKET_CHANGED→更新bucket<br>- 案件状态=OPEN | - [ ] 事件消费成功<br>- [ ] 案件创建<br>- [ ] bucket正确 | `/services/collection-svc/src/case-creation.consumer.ts` |
| H-3 | collection-svc：案件分配 | 实现自动/手动分案逻辑 | H-2 | - `services/collection-svc/src/assign.controller.ts`<br>- `services/collection-svc/src/assign.service.ts` | `POST /admin/collection/assign`<br>请求：`{caseIds[], collectorId, strategy}`<br>响应：`{success}` | - 分案逻辑正确<br>- 负载均衡 | - 策略：金额/地区/坐席负载<br>- 自动分案定时任务<br>- 分案记录 | - [ ] 分案成功<br>- [ ] 负载均衡验证<br>- [ ] 分案日志 | `/services/collection-svc/src/assign.*` |
| H-4 | collection-svc：我的案件列表 | 坐席查询分配给自己的案件 | H-3 | - `services/collection-svc/src/my-cases.controller.ts`<br>- `services/collection-svc/src/my-cases.service.ts` | `GET /collection/my-cases?bucket=&status=` → `{cases[]}` | - 权限校验<br>- 分页查询 | - 仅返回当前坐席案件<br>- 按逾期天数排序<br>- 支持筛选 | - [ ] 权限验证<br>- [ ] 分页正确<br>- [ ] 筛选生效 | `/services/collection-svc/src/my-cases.*` |
| H-5 | collection-svc：催收工作台 | 提供案件详情与快捷操作接口 | H-4 | - `services/collection-svc/src/workspace.controller.ts`<br>- `services/collection-svc/src/workspace.service.ts` | `GET /collection/case/{caseId}/workspace` → `{loan, user, contacts, actions[]}` | - 聚合信息完整<br>- 响应性能 | - 聚合loan-svc/user-svc数据<br>- 联系方式脱敏<br>- 历史动作列表 | - [ ] 信息完整<br>- [ ] 响应时间达标<br>- [ ] 脱敏生效 | `/services/collection-svc/src/workspace.*` |
| H-6 | collection-svc：催收动作记录 | 记录外呼/短信/WhatsApp/备注 | H-5 | - `services/collection-svc/src/action.controller.ts`<br>- `services/collection-svc/src/action.service.ts`<br>- `services/collection-svc/src/action.entity.ts` | `POST /collection/action`<br>请求：`{caseId, type, content, result}`<br>响应：`{success}` | - 动作记录保存<br>- 时间戳 | - 类型：CALL/SMS/WHATSAPP/NOTE<br>- 结果：ANSWERED/BUSY/NO_ANSWER<br>- 通话录音URL（可选） | - [ ] 动作记录入库<br>- [ ] 时间戳正确<br>- [ ] 录音URL保存 | `/services/collection-svc/src/action.*` |
| H-7 | collection-svc：PTP管理 | 创建/更新/检查承诺还款（Promise To Pay） | H-6 | - `services/collection-svc/src/ptp.controller.ts`<br>- `services/collection-svc/src/ptp.service.ts`<br>- `services/collection-svc/src/ptp.entity.ts` | `POST /collection/ptp`<br>请求：`{caseId, promiseDate, amount}`<br>响应：`{ptpId}` | - PTP创建<br>- 到期检查 | - 案件状态=PTP<br>- 到期未还→BROKEN_PTP<br>- 还款自动兑现 | - [ ] PTP记录入库<br>- [ ] 到期检查任务<br>- [ ] 自动状态更新 | `/services/collection-svc/src/ptp.*` |
| H-8 | collection-svc：催收绩效 | 统计坐席绩效（接通率/回款率/PTP率） | H-6, H-7 | - `services/collection-svc/src/performance.controller.ts`<br>- `services/collection-svc/src/performance.service.ts` | `GET /admin/collection/performance?collectorId=&startDate=&endDate=` → `{metrics}` | - 指标计算正确<br>- 查询性能 | - 接通率=接通次数/拨打次数<br>- 回款率=回款金额/案件总额<br>- PTP率=PTP次数/跟进次数 | - [ ] 指标计算验证<br>- [ ] 查询性能达标<br>- [ ] 导出功能 | `/services/collection-svc/src/performance.*` |

---

## Epic I：渠道与报表

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| I-1 | 渠道表DDL | 创建channel_link/attribution_log/app_package/app_release表 | A-3 | - `migrations/008_create_channel_tables.ts` | 无（数据库Schema） | - 迁移执行成功<br>- 归因字段 | - 渠道码唯一索引<br>- 归因日志<br>- App版本管理 | - [ ] 迁移执行成功<br>- [ ] 渠道码唯一<br>- [ ] 版本字段完整 | `/migrations/008_*.ts` |
| I-2 | channel-svc：渠道链接生成 | 生成带参下载链接，保存渠道配置 | I-1 | - `services/channel-svc/src/link.controller.ts`<br>- `services/channel-svc/src/link.service.ts`<br>- `services/channel-svc/src/link.entity.ts` | `POST /admin/channel/link`<br>请求：`{name, campaign, adset, params}`<br>响应：`{linkUrl, code}` | - 链接生成<br>- 短链（可选） | - 链接包含UTM参数<br>- 渠道码生成<br>- Kochava集成（stub） | - [ ] 链接生成成功<br>- [ ] 渠道码唯一<br>- [ ] UTM参数正确 | `/services/channel-svc/src/link.*` |
| I-3 | channel-svc：归因记录 | 记录安装归因（deviceId→渠道） | I-2, B-5 | - `services/channel-svc/src/attribution.controller.ts`<br>- `services/channel-svc/src/attribution.service.ts` | `POST /channel/attribution`<br>请求：`{deviceId, channel, campaign, clickTime}` | - 归因记录保存<br>- 去重 | - 首次归因优先<br>- 设备去重<br>- 归因窗口（7天） | - [ ] 归因记录入库<br>- [ ] 去重逻辑正确<br>- [ ] 归因窗口生效 | `/services/channel-svc/src/attribution.*` |
| I-4 | report-svc：平台每日统计v1 | 计算每日核心指标（SQL聚合） | B-4, D-3, E-3, E-7, F-6 | - `services/report-svc/src/daily.controller.ts`<br>- `services/report-svc/src/daily.service.ts`<br>- `services/report-svc/src/views/daily_stats.sql` | `GET /admin/report/daily?startDate=&endDate=` → `{stats[]}` | - 指标计算正确<br>- 查询性能 | - 指标：注册/登录/申请/放款/还款/逾期/首逾率<br>- 物化视图/定时任务<br>- 支持筛选（渠道/App包） | - [ ] 指标验证<br>- [ ] 查询性能达标<br>- [ ] 筛选生效 | `/services/report-svc/src/daily.*`<br>`/services/report-svc/src/views/` |
| I-5 | report-svc：逾期迁移率 | 计算分桶迁移矩阵（D0→D1→...） | F-6, H-2 | - `services/report-svc/src/migration.controller.ts`<br>- `services/report-svc/src/migration.service.ts` | `GET /admin/report/overdue-migration?cohortDate=` → `{matrix}` | - 迁移率计算正确<br>- Cohort分析 | - D0→D1→D3→D7→D15→D30<br>- 按放款日期分组<br>- 迁移率=迁移笔数/上桶笔数 | - [ ] 迁移率验证<br>- [ ] Cohort分组正确<br>- [ ] 导出功能 | `/services/report-svc/src/migration.*` |
| I-6 | report-svc：复借率 | 计算复借率（结清→再借） | D-3 | - `services/report-svc/src/relend.controller.ts`<br>- `services/report-svc/src/relend.service.ts` | `GET /admin/report/relend-rate?startDate=&endDate=` → `{rate}` | - 复借率计算正确<br>- 按周期统计 | - 复借率=复借用户数/结清用户数<br>- 按天/周/月<br>- 复借次数分布 | - [ ] 复借率验证<br>- [ ] 周期统计正确<br>- [ ] 次数分布准确 | `/services/report-svc/src/relend.*` |
| I-7 | report-svc：渠道漏斗 | 计算渠道转化漏斗（点击→安装→注册→申请→放款） | I-3, B-4, D-3, E-3 | - `services/report-svc/src/channel-funnel.controller.ts`<br>- `services/report-svc/src/channel-funnel.service.ts` | `GET /admin/report/channel-funnel?channel=&startDate=` → `{funnel}` | - 漏斗计算正确<br>- 转化率 | - 各环节转化率<br>- CPA/CPL/CPD计算<br>- 按渠道/广告组/包名筛选 | - [ ] 漏斗计算验证<br>- [ ] 转化率正确<br>- [ ] 筛选生效 | `/services/report-svc/src/channel-funnel.*` |

---

## Epic J：管理后台（Admin Web）

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| J-1 | Admin骨架与路由 | 初始化React项目，配置路由与布局 | A-1 | - `apps/admin-web/src/App.tsx`<br>- `apps/admin-web/src/layouts/BasicLayout.tsx`<br>- `apps/admin-web/src/routes.tsx` | 无（前端项目） | - 本地启动成功<br>- 路由跳转正常 | - Ant Design Pro配置<br>- 左侧菜单<br>- 路由鉴权（空壳） | - [ ] 本地dev server启动<br>- [ ] 路由配置正确<br>- [ ] 布局显示正常 | `/apps/admin-web/` |
| J-2 | Admin登录页 | 实现登录页，调用auth-svc | J-1, B-3 | - `apps/admin-web/src/pages/Login/index.tsx`<br>- `apps/admin-web/src/services/auth.ts` | 无（调用后端接口） | - 登录成功跳转<br>- Token存储 | - 用户名/密码登录<br>- JWT存localStorage<br>- 失败提示 | - [ ] 登录成功跳转首页<br>- [ ] Token保存<br>- [ ] 错误提示显示 | `/apps/admin-web/src/pages/Login/` |
| J-3 | Admin首页看板 | 展示今日核心指标卡片与趋势图 | J-2, I-4 | - `apps/admin-web/src/pages/Dashboard/index.tsx`<br>- `apps/admin-web/src/services/report.ts` | 无（调用后端接口） | - 指标展示正确<br>- 图表渲染 | - 卡片：放款/还款/逾期/首逾率<br>- 趋势图：近14天<br>- 筛选：日期/渠道 | - [ ] 数据加载成功<br>- [ ] 图表渲染正确<br>- [ ] 筛选生效 | `/apps/admin-web/src/pages/Dashboard/` |
| J-4 | Admin全部申请列表 | 实现申请列表页（筛选/分页/导出） | J-2, D-3 | - `apps/admin-web/src/pages/Loan/LoanList.tsx`<br>- `apps/admin-web/src/services/loan.ts` | 无（调用后端接口） | - 列表展示<br>- 筛选/分页<br>- 导出 | - 表头：贷款编号/用户/状态/金额/时间<br>- 筛选项：手机号/状态/日期/渠道<br>- 导出CSV | - [ ] 列表加载成功<br>- [ ] 筛选生效<br>- [ ] 导出功能正常 | `/apps/admin-web/src/pages/Loan/LoanList.tsx` |
| J-5 | Admin申请详情页（四Tab） | 实现申请详情页（客户信息/审批/历史/凭证） | J-4, D-8 | - `apps/admin-web/src/pages/Loan/LoanDetail.tsx`<br>- `apps/admin-web/src/pages/Loan/components/` | 无（调用后端接口） | - 四个Tab切换<br>- 数据完整 | - Tab：客户信息/审批信息/历史记录/凭证<br>- OCR编辑按钮<br>- 审批按钮 | - [ ] Tab切换正常<br>- [ ] 数据加载完整<br>- [ ] 按钮可点击 | `/apps/admin-web/src/pages/Loan/LoanDetail.tsx` |
| J-6 | Admin人工审批弹窗 | 实现审批弹窗（通过/拒绝/理由） | J-5, D-5 | - `apps/admin-web/src/pages/Loan/components/ApprovalModal.tsx` | 无（调用后端接口） | - 弹窗交互<br>- 审批提交 | - 审批结果：通过/拒绝<br>- 拒绝原因下拉<br>- 备注输入 | - [ ] 弹窗打开关闭<br>- [ ] 审批提交成功<br>- [ ] 列表刷新 | `/apps/admin-web/src/pages/Loan/components/ApprovalModal.tsx` |
| J-7 | Admin催收案件列表 | 实现催收案件列表（筛选/分配） | J-2, H-4 | - `apps/admin-web/src/pages/Collection/CaseList.tsx`<br>- `apps/admin-web/src/services/collection.ts` | 无（调用后端接口） | - 列表展示<br>- 分配功能 | - 表头：贷款编号/用户/逾期天数/桶/坐席<br>- 筛选：桶/坐席/状态<br>- 批量分配 | - [ ] 列表加载成功<br>- [ ] 筛选生效<br>- [ ] 分配提交成功 | `/apps/admin-web/src/pages/Collection/CaseList.tsx` |
| J-8 | Admin催收工作台 | 实现催收工作台（案件详情+快捷操作） | J-7, H-5, H-6 | - `apps/admin-web/src/pages/Collection/Workspace.tsx`<br>- `apps/admin-web/src/pages/Collection/components/` | 无（调用后端接口） | - 案件信息展示<br>- 快捷操作 | - 借款人信息/联系方式/账单<br>- 快捷操作：外呼/短信/备注/PTP<br>- 历史动作列表 | - [ ] 信息展示完整<br>- [ ] 操作提交成功<br>- [ ] 动作记录刷新 | `/apps/admin-web/src/pages/Collection/Workspace.tsx` |
| J-9 | Admin平台每日统计页 | 展示平台每日统计报表 | J-2, I-4 | - `apps/admin-web/src/pages/Report/DailyStats.tsx` | 无（调用后端接口） | - 报表展示<br>- 筛选/导出 | - 表格：日期/注册/申请/放款/还款/逾期/首逾率<br>- 筛选：日期/渠道/App包<br>- 导出 | - [ ] 报表加载成功<br>- [ ] 筛选生效<br>- [ ] 导出功能正常 | `/apps/admin-web/src/pages/Report/DailyStats.tsx` |
| J-10 | Admin渠道统计页 | 展示渠道漏斗与转化率 | J-2, I-7 | - `apps/admin-web/src/pages/Report/ChannelFunnel.tsx` | 无（调用后端接口） | - 漏斗图展示<br>- 转化率计算 | - 漏斗：点击→安装→注册→申请→放款<br>- 表格：各渠道转化率/CPA<br>- 筛选：渠道/日期 | - [ ] 漏斗图渲染<br>- [ ] 转化率正确<br>- [ ] 筛选生效 | `/apps/admin-web/src/pages/Report/ChannelFunnel.tsx` |

---

## Epic K：移动端（Flutter App）

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| K-1 | Flutter项目初始化 | 初始化Flutter项目，配置路由与主题 | A-1 | - `apps/mobile-app/lib/main.dart`<br>- `apps/mobile-app/lib/routes.dart`<br>- `apps/mobile-app/lib/theme.dart` | 无（移动应用） | - App启动成功<br>- 路由跳转正常 | - GetX/Bloc状态管理<br>- 多语言i18n<br>- 主题配置 | - [ ] App启动无错误<br>- [ ] 路由配置正确<br>- [ ] 主题显示正常 | `/apps/mobile-app/` |
| K-2 | App登录页 | 实现手机号登录（OTP） | K-1, B-2, B-3 | - `apps/mobile-app/lib/pages/auth/login_page.dart`<br>- `apps/mobile-app/lib/services/auth_service.dart` | 无（调用后端接口） | - OTP发送<br>- 登录成功 | - 手机号输入框<br>- 发送OTP按钮（60s倒计时）<br>- OTP输入框<br>- 登录跳转首页 | - [ ] OTP发送成功<br>- [ ] 倒计时显示<br>- [ ] 登录跳转 | `/apps/mobile-app/lib/pages/auth/` |
| K-3 | App首页（授信） | 展示可借额度与申请入口 | K-2, D-2 | - `apps/mobile-app/lib/pages/home/home_page.dart`<br>- `apps/mobile-app/lib/services/loan_service.dart` | 无（调用后端接口） | - 额度展示<br>- 申请按钮 | - 可借额度卡片<br>- 期限选择<br>- 费用明细<br>- 申请按钮 | - [ ] 额度加载成功<br>- [ ] 期限可选<br>- [ ] 费用计算正确 | `/apps/mobile-app/lib/pages/home/` |
| K-4 | App KYC页 | 实现身份证OCR与活体检测 | K-3, B-6, B-7 | - `apps/mobile-app/lib/pages/kyc/ocr_page.dart`<br>- `apps/mobile-app/lib/pages/kyc/liveness_page.dart`<br>- `apps/mobile-app/lib/services/kyc_service.dart` | 无（调用后端接口） | - 拍照上传<br>- OCR识别<br>- 活体检测 | - 调用相机拍照<br>- 图片压缩上传<br>- OCR结果展示<br>- 活体视频录制 | - [ ] 拍照功能正常<br>- [ ] 上传成功<br>- [ ] OCR结果显示 | `/apps/mobile-app/lib/pages/kyc/` |
| K-5 | App申请页 | 提交贷款申请 | K-4, D-3 | - `apps/mobile-app/lib/pages/loan/apply_page.dart` | 无（调用后端接口） | - 提交申请<br>- 状态展示 | - 金额/期限确认<br>- 费用明细<br>- 提交按钮<br>- 审核中提示 | - [ ] 申请提交成功<br>- [ ] 状态显示正确<br>- [ ] 费用计算准确 | `/apps/mobile-app/lib/pages/loan/` |
| K-6 | App合同签署页 | 展示合同PDF与签署 | K-5, D-6, D-7 | - `apps/mobile-app/lib/pages/contract/sign_page.dart`<br>- `apps/mobile-app/lib/services/contract_service.dart` | 无（调用后端接口） | - PDF显示<br>- 签署提交 | - PDF加载（WebView/PDF插件）<br>- 勾选协议<br>- 签署按钮（OTP验证）<br>- 签署成功跳转 | - [ ] PDF显示正常<br>- [ ] 签署提交成功<br>- [ ] 跳转正确 | `/apps/mobile-app/lib/pages/contract/` |
| K-7 | App账单页 | 展示账单与还款入口 | K-6, F-6 | - `apps/mobile-app/lib/pages/bill/bill_page.dart` | 无（调用后端接口） | - 账单展示<br>- 还款按钮 | - 应还金额/到期日/剩余天数<br>- 费用拆分<br>- 还款按钮<br>- 还款记录 | - [ ] 账单加载成功<br>- [ ] 金额显示正确<br>- [ ] 还款按钮可点击 | `/apps/mobile-app/lib/pages/bill/` |
| K-8 | App还款页 | 选择还款方式与支付 | K-7, E-6 | - `apps/mobile-app/lib/pages/repay/repay_page.dart`<br>- `apps/mobile-app/lib/services/payment_service.dart` | 无（调用后端接口） | - 还款方式选择<br>- 支付跳转 | - 通道选择（银行卡/钱包）<br>- 金额输入（全额/部分）<br>- 支付按钮<br>- 跳转收银台/WebView | - [ ] 通道可选<br>- [ ] 金额校验<br>- [ ] 支付跳转成功 | `/apps/mobile-app/lib/pages/repay/` |

---

## Epic L：测试与上线准备

| ID | 任务名 | 目标摘要 | 输入依赖 | 主要改动 | 对外接口 | 测试点 | DoD | 自检清单 | 产物路径 |
|----|--------|----------|----------|----------|----------|--------|-----|----------|----------|
| L-1 | 端到端测试脚本 | 编写端到端测试（注册→申请→放款→还款） | All Core Tasks | - `tests/e2e/user-journey.spec.ts`<br>- `tests/e2e/fixtures/` | 无 | - 测试通过<br>- 覆盖核心流程 | - Postman/k6/Jest<br>- 断言状态/金额/事件<br>- 测试数据清理 | - [ ] 测试通过率100%<br>- [ ] 覆盖核心路径<br>- [ ] 数据清理脚本 | `/tests/e2e/` |
| L-2 | 性能测试 | 对核心接口进行压测（k6） | All Core Tasks | - `tests/performance/load-test.js`<br>- `tests/performance/stress-test.js` | 无 | - P95 ≤ 200ms<br>- 并发5000 | - 登录/申请/放款/还款接口<br>- 并发用户模拟<br>- 性能报告 | - [ ] P95达标<br>- [ ] 无超时错误<br>- [ ] 报告生成 | `/tests/performance/` |
| L-3 | 安全测试 | 执行安全扫描与漏洞修复 | All Core Tasks | - 安全扫描报告<br>- 修复Commit | 无 | - 无高危漏洞<br>- SQL注入防护 | - OWASP Top 10检查<br>- SQL注入/XSS测试<br>- 敏感信息泄露检查 | - [ ] 高危漏洞清零<br>- [ ] 中危漏洞评估<br>- [ ] 扫描报告归档 | `/docs/security/` |
| L-4 | 生产环境部署清单 | 编写部署清单与运维手册 | A-7, A-8 | - `docs/deployment.md`<br>- `docs/ops-manual.md`<br>- `k8s/production/` | 无 | - 清单完整<br>- 手册可用 | - K8s YAML<br>- 环境变量清单<br>- 数据库迁移步骤<br>- 回滚方案 | - [ ] 清单review通过<br>- [ ] 手册可执行<br>- [ ] 回滚验证 | `/docs/`<br>`/k8s/production/` |
| L-5 | 监控告警配置 | 配置Prometheus/Grafana/AlertManager | All Core Tasks | - `infra/prometheus/rules.yml`<br>- `infra/grafana/dashboards/`<br>- `infra/alertmanager/config.yml` | 无 | - 告警触发<br>- 通知送达 | - 告警规则：错误率/响应时间/放款失败<br>- Dashboard：业务指标/技术指标<br>- 通知渠道：钉钉/Slack | - [ ] 告警规则生效<br>- [ ] Dashboard显示<br>- [ ] 通知送达验证 | `/infra/prometheus/`<br>`/infra/grafana/` |

---

## 任务执行顺序建议

**Phase 1：基础设施（Week 1-2）**
- A-1 → A-2 → A-3 → A-4 → A-5 → A-6 → A-7 → A-8 → A-9

**Phase 2：认证与用户（Week 3-4）**
- B-1 → B-2 → B-3 → B-4 → B-5 → B-6 → B-7 → B-8 → B-9

**Phase 3：风控（Week 5-6）**
- C-1 → C-2 → C-3 → C-4 → C-5 → C-6

**Phase 4：贷款（Week 7-8）**
- D-1 → D-2 → D-3 → D-4 → D-5 → D-6 → D-7 → D-8

**Phase 5：支付（Week 9-10）**
- E-1 → E-2 → E-3 → E-4 → E-5 → E-6 → E-7

**Phase 6：账务（Week 11-12）**
- F-1 → F-2 → F-3 → F-4 → F-5 → F-6 → F-7 → F-8

**Phase 7：通知与催收（Week 13-14）**
- G-1 → G-2 → G-3 → G-4 → G-5（并行）
- H-1 → H-2 → H-3 → H-4 → H-5 → H-6 → H-7 → H-8

**Phase 8：渠道与报表（Week 15-16）**
- I-1 → I-2 → I-3 → I-4 → I-5 → I-6 → I-7

**Phase 9：前端（Week 17-18，可与后端并行）**
- J-1 → J-2 → J-3 → J-4 → J-5 → J-6 → J-7 → J-8 → J-9 → J-10（Admin）
- K-1 → K-2 → K-3 → K-4 → K-5 → K-6 → K-7 → K-8（App）

**Phase 10：测试与上线（Week 19-20）**
- L-1 → L-2 → L-3 → L-4 → L-5

---

## 并行化建议

**可并行执行的任务组**：
1. **基础设施组**：A-3（数据库） || A-4（Redis） || A-5（Kafka） || A-9（MinIO）
2. **服务开发组**：
   - 用户/认证：B系列
   - 风控：C系列（依赖B完成后）
   - 贷款：D系列（依赖C完成后）
   - 支付/账务：E系列 || F系列（部分任务可并行）
3. **前端组**：J系列（Admin） || K系列（App），依赖后端接口完成

**关键路径**（影响上线时间）：
- A（基础） → B（认证） → C（风控） → D（贷款） → E（支付） → F（账务） → L（测试）

**建议团队配置**：
- 后端开发1：A系列 + B系列 + E系列
- 后端开发2：C系列 + D系列 + I系列
- 后端开发3：F系列 + G系列 + H系列
- 前端开发1：J系列（Admin）
- 前端开发2：K系列（App）
- 测试/DevOps：A-8、L系列，全程参与各模块测试

---

**文档版本**：v1.0  
**创建日期**：2025-01-07  
**总任务数**：100+  
**预计工期**：18-20周（MVP）

