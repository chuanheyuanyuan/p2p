# 项目蓝图

## 1. 项目目标

**北极星目标（12个月）**
- 搭建可运营、可扩展的P2P/现金贷平台，完成注册→授信→申请→放款→账单/还款→催收→复借的闭环
- MVP后90天关键指标：
  - 注册→申请转化率 ≥ 35%，申请→放款转化率 ≥ 20%
  - 放款后首逾率（D0）≤ 40%
  - 核心链路P95 ≤ 200ms，放/还款可用性 ≥ 99.9%
  - 回调幂等错误率 ≤ 0.1%

**成功标准**
- 完整业务流程可演示（端到端）
- 核心报表上线（平台每日统计、逾期迁移率、渠道统计、复借率）
- 生产环境稳定运行，支持真实资金流转

## 2. 系统边界

**范围内（Phase 1 - MVP）**
- 借款端App（Flutter）：注册/KYC/申请/签约/还款/账单
- 管理后台（React + Ant Design Pro）：审批/财务/催收/运营配置/报表
- 核心微服务：用户/认证/风控/贷款/支付/账务/通知/催收/渠道/报表
- 基础设施：API网关、事件总线、数据库、对象存储、监控

**范围外（延后至Phase 2/3）**
- P2P资金方撮合（二期）
- AI外呼机器人（二期）
- 电销完整模块（二期）
- 高级数仓（ClickHouse，一期用PostgreSQL + 物化视图）

**假设**
- 目标市场：加纳/尼日利亚，币种GHS/NGN/USD可配置
- 首期使用沙箱支付通道（XPay/MTN Mobile Money stub）
- 三方服务对接先用Mock（OCR/活体/Kochava），预留接口切换
- 部署：容器化（Docker），K8s生产环境，本地用Docker Compose
- 团队规模：2-3后端 + 1-2前端 + 1测试/DevOps

## 3. 技术架构

### 3.1 技术栈

**前端**
- 移动端：Flutter 3.x（iOS/Android）
- 管理端：React 18 + Ant Design Pro 6 + TypeScript

**后端**
- 业务服务：NestJS（TypeScript） + TypeORM
- 风控引擎：Python FastAPI（规则引擎灵活性）
- API网关：Kong（鉴权、限流、灰度）
- 事件总线：Kafka（或RabbitMQ轻量级替代）
- 存储：PostgreSQL 15（主库）、Redis 7（缓存/会话/分布式锁）
- 文件：MinIO（S3兼容）
- 监控：Prometheus + Grafana + Loki

**基础设施**
- 容器：Docker + K8s（生产）
- CI/CD：GitHub Actions + ArgoCD
- 代码管理：Monorepo（pnpm workspace）

### 3.2 服务拓扑

```
[Kong API Gateway]
  ├── /api/auth/*       → auth-svc (登录/OTP)
  ├── /api/user/*       → user-svc (用户/KYC/设备)
  ├── /api/risk/*       → risk-svc (规则/评分)
  ├── /api/loan/*       → loan-svc (申请/审批/合同)
  ├── /api/payment/*    → payment-svc (放款/还款网关)
  ├── /api/ledger/*     → ledger-svc (账务/台账)
  ├── /api/notify/*     → notify-svc (短信/邮件/Push)
  ├── /api/collection/* → collection-svc (催收)
  ├── /api/channel/*    → channel-svc (渠道归因)
  ├── /api/report/*     → report-svc (报表)
  ├── /bff/mobile       → bff-mobile (App聚合)
  └── /bff/admin        → bff-admin (后台聚合)

[Kafka Topics]
  - user.events (USER_REGISTERED, KYC_PASSED/FAILED)
  - loan.events (LOAN_APPLIED, APPROVED, REJECTED)
  - payment.events (DISBURSED, DISBURSE_FAILED, REPAYMENT_POSTED)
  - collection.events (DUE_TODAY, OVERDUE_BUCKET_CHANGED, CASE_ASSIGNED, PTP)
```

### 3.3 数据架构

**核心实体**
- User（用户）、Device（设备）、KYC（身份认证）
- Loan（贷款）、LoanOffer（报价）、LoanAudit（审批记录）、Contract（合同）
- Disbursement（放款）、Repayment（还款）、LedgerEntry（账务分录）
- CollectionCase（催收案件）、CollectionAction（催收动作）
- Channel（渠道）、Attribution（归因）
- AppPackage（App包）、AppRelease（版本）

**数据库设计原则**
- 使用UUID作为主键（分布式友好）
- 金额字段统一使用DECIMAL(18,2)
- 时间字段统一使用timestamp with time zone
- 敏感字段加密存储（AES-256）
- 所有表包含created_at/updated_at/deleted_at（软删除）

## 4. 领域模型

### 4.1 用户域（User Domain）

**聚合根：User**
- 实体：User、KYC、Device、Contact、UserAccount
- 值对象：Phone、Address、GeoLocation
- 领域服务：UserRegistrationService、KYCVerificationService

**状态机：KYC Status**
```
PENDING → OCR_PROCESSING → LIVENESS_PROCESSING → 
{VERIFIED | REJECTED | MANUAL_REVIEW}
```

### 4.2 风控域（Risk Domain）

**聚合根：RiskAssessment**
- 实体：Rule、Strategy、Blacklist、RiskLog
- 值对象：RiskScore、Decision（APPROVE/REJECT/MANUAL）
- 领域服务：RuleEngine、ScoringService、BlacklistChecker

**决策流程**
```
Input(User, Loan, Signals) → RuleEngine → Score → Strategy → Decision
```

### 4.3 贷款域（Loan Domain）

**聚合根：Loan**
- 实体：Loan、LoanOffer、LoanAudit、Contract、Bill
- 值对象：Amount、Term、FeeStructure
- 领域服务：LoanApplicationService、ApprovalService、ContractGenerationService

**状态机：Loan Status**
```
DRAFT → SUBMITTED → AUTO_CHECKING → {AUTO_REJECTED | AUTO_APPROVED}
→ {MANUAL_REVIEW | SKIP_MANUAL} → {MANUAL_REJECTED | APPROVED}
→ DISBURSE_PENDING → {DISBURSED | DISBURSE_FAILED}
→ ACTIVE → {REPAID | DUE | EXTENDED}
→ {OVERDUE_D0/D1/D3/D7/D15/D30/...}
→ {PARTIAL_PAID | PTP | WRITE_OFF} → CLOSED
```

### 4.4 资金域（Payment Domain）

**聚合根：Payment**
- 实体：Disbursement、Repayment、PaymentChannel、Reconciliation
- 值对象：PaymentMethod、ChannelConfig
- 领域服务：PaymentGateway、ChannelRouter、IdempotencyChecker

**支付状态机**
```
PENDING → PROCESSING → {SUCCESS | FAILED} → {RETRY | SETTLED}
```

### 4.5 账务域（Ledger Domain）

**聚合根：Account**
- 实体：Account、LedgerEntry、BalanceSnapshot
- 值对象：Money、AccountCode
- 领域服务：DoubleEntryBookkeeper、BalanceCalculator

**科目体系**
```
资产：
  - 现金 (CASH)
  - 应收贷款本金 (LOAN_PRINCIPAL)
  - 应收利息 (INTEREST_RECEIVABLE)
负债：
  - 用户待结算 (USER_SETTLEMENT)
收入：
  - 利息收入 (INTEREST_INCOME)
  - 服务费收入 (SERVICE_FEE_INCOME)
费用：
  - 通道费用 (CHANNEL_FEE)
```

### 4.6 催收域（Collection Domain）

**聚合根：CollectionCase**
- 实体：CollectionCase、CollectionAction、PTP、Collector
- 值对象：Bucket（D0/D1/D3/...）、ContactMethod
- 领域服务：CaseAssignmentService、ActionRecorder、PerformanceCalculator

**案件状态机**
```
OPEN → IN_PROGRESS → {PTP | BROKEN_PTP | PARTIAL_PAID | REPAID | TRANSFERRED | WRITE_OFF}
```

## 5. 关键业务流程

### 5.1 注册登录流程

```
1. App发送手机号 → auth-svc.sendOTP()
2. 验证OTP → auth-svc.login() → 签发JWT
3. 上报设备信息 → user-svc.registerDevice()
4. 发布事件：USER_REGISTERED
```

### 5.2 KYC流程

```
1. 上传身份证 → user-svc.uploadIDCard() → MinIO
2. 调用OCR服务（stub）→ user-svc.saveOCRResult()
3. 上传活体视频 → user-svc.uploadLiveness() → MinIO
4. 调用活体检测（stub）→ user-svc.saveLivenessResult()
5. 综合判定 → user-svc.updateKYCStatus()
6. 发布事件：KYC_PASSED / KYC_FAILED
```

### 5.3 申请与审批流程

```
1. App提交申请 → loan-svc.apply() → 状态=SUBMITTED
2. loan-svc发布LOAN_APPLIED事件
3. loan-svc调用risk-svc.evaluate()
4. risk-svc返回决策(APPROVE/REJECT/MANUAL)
5. 若APPROVE → loan-svc更新状态=AUTO_APPROVED
   若REJECT → loan-svc更新状态=AUTO_REJECTED
   若MANUAL → loan-svc更新状态=MANUAL_REVIEW，进入人工队列
6. 人工审批 → admin调用loan-svc.manualReview()
7. 审批通过 → 状态=APPROVED
8. 发布事件：LOAN_APPROVED / LOAN_REJECTED
```

### 5.4 放款流程

```
1. loan-svc监听LOAN_APPROVED → 生成合同PDF → MinIO
2. App签署合同 → loan-svc.signContract()
3. loan-svc调用payment-svc.disburse({loanId, amount, account})
4. payment-svc选择通道 → 调用通道API（沙箱）
5. 状态=DISBURSE_PENDING → 轮询/回调 → {SUCCESS | FAILED}
6. 若SUCCESS:
   - payment-svc发布DISBURSED事件
   - ledger-svc监听事件 → 入账（借:LOAN_PRINCIPAL, 贷:CASH）
   - loan-svc监听事件 → 更新状态=ACTIVE
7. 若FAILED:
   - payment-svc发布DISBURSE_FAILED事件
   - 触发重试/切换通道逻辑
```

### 5.5 还款流程

```
1. App选择还款方式 → payment-svc.pay({loanId, amount, channel})
2. payment-svc生成支付链接/跳转收银台
3. 用户完成支付 → 通道回调payment-svc.callback()
4. payment-svc验证签名 → 幂等检查（X-Idempotency-Key）
5. payment-svc发布REPAYMENT_POSTED事件
6. ledger-svc监听 → 入账（借:CASH, 贷:LOAN_PRINCIPAL/INTEREST）
7. loan-svc监听 → 更新账单状态（全额=REPAID，部分=PARTIAL_PAID）
8. notify-svc监听 → 发送还款成功通知
```

### 5.6 催收流程

```
1. 定时任务扫描到期订单 → loan-svc发布DUE_TODAY事件
2. collection-svc监听 → 自动建案（状态=OPEN, bucket=D0）
3. 到期未还 → loan-svc发布OVERDUE_BUCKET_CHANGED事件
4. collection-svc更新bucket（D0→D1→D3→...）
5. 自动分案规则 → collection-svc.assignCase()
6. 坐席在工作台查看案件 → collection-svc.getMyCases()
7. 坐席执行动作（外呼/短信/PTP）→ collection-svc.recordAction()
8. 用户承诺还款 → collection-svc.createPTP({caseId, amount, promiseDate})
9. 用户还款 → loan-svc监听REPAYMENT_POSTED → 更新账单 → collection-svc.closeCase()
```

## 6. 非功能要求

### 6.1 性能

| 指标 | 目标 | 度量方法 |
|------|------|----------|
| API响应时间（P95） | ≤ 200ms | Prometheus + Grafana |
| API响应时间（P99） | ≤ 500ms | Prometheus + Grafana |
| 并发用户数 | ≥ 5000 | 压测工具（k6/Locust） |
| 数据库连接池 | 20-50 | TypeORM配置 |
| Redis缓存命中率 | ≥ 90% | Redis INFO |

### 6.2 可用性

| 指标 | 目标 | 容灾措施 |
|------|------|----------|
| 核心链路可用性 | ≥ 99.9% | 服务多副本、熔断降级 |
| 数据库可用性 | ≥ 99.95% | PostgreSQL主从 + 自动切换 |
| 事件投递成功率 | ≥ 99.99% | Kafka持久化 + 重试 |
| 回调幂等错误率 | ≤ 0.1% | 幂等键 + 分布式锁 |

### 6.3 安全

**传输安全**
- 全站HTTPS（TLS 1.3）
- API签名验证（HMAC-SHA256）
- JWT token（15分钟过期，刷新token机制）

**存储安全**
- 敏感字段加密（AES-256-GCM）：身份证号、银行账号
- 密码加密（bcrypt，cost=12）
- 数据库连接加密（SSL）

**权限控制**
- RBAC（Role-Based Access Control）
- 菜单级 + 按钮级 + 数据行级权限
- 操作审计日志（谁在何时对何资源做了什么）

**合规要求**
- 隐私政策 + 用户协议（首次启动强制勾选）
- 敏感权限二次弹窗说明
- 数据脱敏展示（手机号/证件号）
- 审计日志保留≥3年

### 6.4 数据一致性

**金融场景强一致性要求**
- 放款/还款操作：使用数据库事务 + 分布式锁
- 账务入账：双分录强制借贷平衡，事务内完成
- 幂等性：所有写操作要求X-Idempotency-Key
- 补偿机制：支付失败自动重试，定时对账任务

**精度要求**
- 金额字段：DECIMAL(18, 2)，禁用FLOAT/DOUBLE
- 计算：使用decimal.js（JS）或Python Decimal
- 四舍五入：统一规则（向上取分）

### 6.5 可观测性

**日志**
- 结构化日志（JSON格式）
- 统一trace_id（OpenTelemetry）
- 日志级别：DEBUG/INFO/WARN/ERROR
- 敏感信息脱敏

**指标**
- 业务指标：注册数/申请数/放款数/还款数/首逾率
- 技术指标：QPS/响应时间/错误率/DB慢查询
- 告警：Prometheus AlertManager → 钉钉/Slack

**追踪**
- 分布式追踪（Jaeger/Zipkin）
- 关键路径埋点（注册→申请→放款→还款）

### 6.6 扩展性

**水平扩展**
- 无状态服务（会话存Redis）
- 数据库读写分离（PostgreSQL主从）
- 缓存分片（Redis Cluster）

**垂直扩展**
- 服务拆分粒度适中（DDD边界）
- 异步解耦（Kafka事件驱动）
- 数据库分表策略（按用户ID哈希，预留）

## 7. 环境与部署

### 7.1 环境定义

| 环境 | 用途 | 域名示例 | 数据库 |
|------|------|----------|--------|
| local | 本地开发 | localhost | Docker Compose |
| dev | 开发联调 | api-dev.example.com | dev-db |
| staging | 预发布 | api-staging.example.com | staging-db（数据脱敏） |
| production | 生产 | api.example.com | prod-db（主从） |

### 7.2 CI/CD流程

```
1. 开发提交代码 → GitHub
2. GitHub Actions触发:
   - Lint (ESLint/Prettier)
   - Unit Test (Jest, coverage ≥ 70%)
   - Build Docker Image
   - Push to Docker Registry
3. ArgoCD监听镜像变更
4. 自动部署到dev环境
5. 自动化测试（Postman/k6）
6. 手动触发部署到staging
7. QA验收
8. 手动触发部署到production（灰度发布）
```

### 7.3 灰度发布策略

- 按用户ID尾号灰度（0-1% → 5% → 20% → 100%）
- 金丝雀部署（新版本先部署1个Pod，观察指标）
- 快速回滚（保留上一版本镜像）

## 8. 数据字典

### 8.1 币种

| Code | Name | Symbol | Decimal Places |
|------|------|--------|----------------|
| GHS | 加纳塞地 | GH₵ | 2 |
| NGN | 尼日利亚奈拉 | ₦ | 2 |
| USD | 美元 | $ | 2 |

### 8.2 语言

| Code | Name |
|------|------|
| en | English |
| zh | 中文 |

### 8.3 贷款状态

| Status | 中文 | 说明 |
|--------|------|------|
| DRAFT | 草稿 | 用户保存但未提交 |
| SUBMITTED | 已提交 | 等待机审 |
| AUTO_CHECKING | 机审中 | 规则引擎处理中 |
| AUTO_APPROVED | 机审通过 | 自动通过 |
| AUTO_REJECTED | 机审拒绝 | 自动拒绝 |
| MANUAL_REVIEW | 人工审核 | 等待人工复核 |
| MANUAL_REJECTED | 人工拒绝 | 人工拒绝 |
| APPROVED | 已批准 | 等待签约 |
| DISBURSE_PENDING | 放款中 | 打款处理中 |
| DISBURSE_FAILED | 放款失败 | 打款失败 |
| ACTIVE | 活跃 | 已放款，还款中 |
| DUE | 到期 | 当日到期 |
| OVERDUE_D0 | 逾期D0 | 逾期0天 |
| OVERDUE_D1 | 逾期D1 | 逾期1天 |
| OVERDUE_D3 | 逾期D3 | 逾期3天 |
| OVERDUE_D7 | 逾期D7 | 逾期7天 |
| OVERDUE_D15 | 逾期D15 | 逾期15天 |
| OVERDUE_D30 | 逾期D30 | 逾期30天 |
| OVERDUE_D60 | 逾期D60 | 逾期60天 |
| OVERDUE_D90 | 逾期D90 | 逾期90天 |
| PARTIAL_PAID | 部分还款 | 部分还款 |
| REPAID | 已结清 | 全额还款 |
| EXTENDED | 已展期 | 已展期 |
| PTP | 承诺还款 | Promise To Pay |
| BROKEN_PTP | 违约承诺 | 承诺未兑现 |
| WRITE_OFF | 核销 | 坏账核销 |
| CLOSED | 已关闭 | 最终状态 |

### 8.4 错误码规范

**格式**：`[模块代码][HTTP状态码][序号]`

**示例**
- `A40001`：认证模块(A) + 400错误 + 序号01 → OTP_LIMIT_EXCEEDED
- `U40401`：用户模块(U) + 404错误 + 序号01 → USER_NOT_FOUND
- `L42201`：贷款模块(L) + 422错误 + 序号01 → INVALID_LOAN_AMOUNT
- `P50001`：支付模块(P) + 500错误 + 序号01 → CHANNEL_TIMEOUT

**模块代码**
- A: Auth（认证）
- U: User（用户）
- R: Risk（风控）
- L: Loan（贷款）
- P: Payment（支付）
- D: Ledger（账务）
- N: Notify（通知）
- C: Collection（催收）
- H: Channel（渠道）
- T: Report（报表）

## 9. 里程碑计划

| Sprint | 周期 | 目标 | 可演示成果 |
|--------|------|------|------------|
| Sprint 0 | Week 1-2 | 基础设施 | 骨架代码，本地运行，健康检查 |
| Sprint 1 | Week 3-4 | 注册登录 | App登录→后台查看用户 |
| Sprint 2 | Week 5-6 | KYC | App上传证件→后台OCR编辑 |
| Sprint 3 | Week 7-8 | 申请审批 | App申请→后台审批→合同 |
| Sprint 4 | Week 9-10 | 放款 | 后台触发放款→沙箱回调→账务入账 |
| Sprint 5 | Week 11-12 | 还款 | App还款→沙箱回调→账单更新 |
| Sprint 6 | Week 13-14 | 催收 | 自动建案→分案→工作台外呼 |
| Sprint 7 | Week 15-16 | 渠道/报表 | Kochava归因→平台每日统计 |
| Sprint 8 | Week 17-18 | 性能/安全 | 压测→优化→上线准备 |

**MVP范围**：Sprint 0-8（18周）

**Phase 2**（4-6周）：外呼机器人、电销、对账完善、真通道切换

**Phase 3**（6-8周）：P2P资金方、撮合、分润

## 10. 关键假设

1. **业务假设**
   - 目标市场：加纳（主）+ 尼日利亚（备）
   - 首期贷款期限：7/14/28天（高频小额）
   - 首期额度：100-5000 GHS
   - 年化利率（APR）：36%-365%（依据当地法规）

2. **技术假设**
   - 团队熟悉TypeScript/NestJS
   - 可使用云服务（AWS/阿里云/腾讯云）
   - 有DevOps支持（K8s集群已准备）
   - 数据量预估：10万用户/年，50万笔订单/年

3. **集成假设**
   - OCR服务：接入第三方（如AnyVision/百度），首期用Mock
   - 活体检测：接入第三方（如Face++），首期用Mock
   - 支付通道：接入XPay/MTN Mobile Money，首期用沙箱
   - Kochava：使用API归因，首期用本地模拟数据

4. **合规假设**
   - 已获得当地金融牌照（或合作持牌机构）
   - 法务已准备合同模板
   - 隐私政策已由律师审核

## 11. 风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 三方服务不稳定 | 高 | 中 | 降级策略，人工兜底 |
| 支付通道延迟 | 高 | 中 | 多通道热备，轮询+回调双机制 |
| 数据库性能瓶颈 | 中 | 中 | 读写分离，索引优化，缓存 |
| 团队能力不足 | 高 | 低 | 技术培训，代码Review，结对编程 |
| 需求频繁变更 | 中 | 高 | 敏捷迭代，每Sprint冻结需求 |
| 安全漏洞 | 高 | 低 | 安全评审，渗透测试，Bug Bounty |

---

**文档版本**：v1.0  
**创建日期**：2025-01-07  
**负责人**：架构师团队  
**审批状态**：待审批

