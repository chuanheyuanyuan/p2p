## 1. 目标与系统边界
### 1.1 业务目标
- 12 个月内上线可运营的 P2P/现金贷平台，形成注册→授信→申请→放款→账单/还款→催收→复借闭环。
- MVP 后 90 天核心指标：注册→申请转化 ≥35%，申请→放款 ≥20%，放/还款可用性 ≥99.9%，首逾 D0 ≤40%，关键链路 P95 ≤200 ms。
- 支撑运营、风控、财务、渠道及催收全角色的可视化与可追溯管理。
### 1.2 系统边界
- 借款端：Flutter 客户端接入 FastAPI 构建的 mobile BFF，负责登录、KYC、授信、账单、复借，BFF 内置 Pydantic 校验、Redis 会话，默认返回 JSON:API +自动生成的 typed clients，方便 vibe coding 一键调试。
- 管理端：React/Ant Design Pro 前端接入 FastAPI admin BFF，负责审批、催收、电销、渠道、配置与报表聚合，复用统一 RBAC 中间件与审计，所有接口在 Swagger & Postman collection 自动更新，便于实时 vibe coding。
- 后端域服务：基于 FastAPI + Pydantic + SQLAlchemy 2.0 的微服务集群（user/auth、risk、loan、payment、ledger、notify、collection、channel、report、p2p[二期]），异步任务使用 Celery + Redis，定时任务使用 APScheduler；全部模块遵循“单职责、小文件、自动样例”以提升 vibe coding 协作。
- 数据与事件：Kafka（或 Redpanda 本地）承载业务事件，ClickHouse/TimescaleDB 负责指标分析，MinIO/S3 保存合同与 KYC 文件，Airflow 调度批处理；事件 schema 由 Python dataclass 自动导出 Markdown 片段，供 vibe coding 直接引用。
- 外部依赖：OCR/活体供应商（REST/Callback）、OTP/SMS（HTTP API）、支付通道（REST+回调）、Kochava/AppsFlyer 归因。
- Out-of-scope（一期）：真实资金撮合、出借人前端、自动对接国家征信局（通过假设 A1/A3 以 mock 方式代替）。

## 2. 技术与模块框架
### 2.1 Vibe Coding 友好的 Python 技术栈
- 框架：FastAPI（热重载 + 自动 OpenAPI）搭配 Pydantic v2（Typed DTO）、SQLModel/SQLAlchemy 2.0（声明式 ORM），默认提供交互式 Swagger + ReDoc 录屏，便于 LLM/Vibe 自动补全。
- 基础库：uvloop + Uvicorn 提升 Dev Server 体验；`python-dotenv` 自动加载多环境；`rich`/`loguru` 输出结构化日志，利于 ChatOps 回放。
- 认证/授权：Authlib OAuth2.1 + python-jose JWT + Casbin-Py；生成的 policy/spec 通过脚本同步到 Vibe 侧边栏，减少人工查阅。
- 数据访问：PostgreSQL 14 + SQLModel schema 自动导出 Markdown；Redis 7（async redis）提供缓存、分布式锁、幂等记录；ClickHouse 23/TimescaleDB 用于指标；MinIO SDK（aioboto3）存储文件。
- 消息与异步：aiokafka 统一事件客户端；Celery 5 + Redis broker 支持定时/重试；APScheduler 负责轻量 cron；全部任务附带 `.task.md` 模板，方便 vibe coding 插件加载上下文。
- 工程实践：Poetry 或 PDM 统一依赖，`uv` 做极速安装；ruff+black+isort 组合；pytest+pytest-asyncio；mypy/pyright；Taskfile/Invoke 封装常用脚本，面向 vibe coding 一句指令即可运行；CI 使用 GitHub Actions + reusable workflow，自动将测试日志推送到 Vibe 房间。

### 2.2 模块总览（Vibe 友好拆分）
| 层级 | Python 组件 | Vibe Coding 增强点 |
| --- | --- | --- |
| API Gateway | Kong + kong-python 插件 | 插件自带 `plugin.md` 说明，vibe 可直接调试限流/鉴权策略。 |
| Mobile BFF | FastAPI、httpx、redis-py | 每个 endpoint 附带 `.http` 示例与 JSON schema，BFF 自动聚合日志回推到 vibe 聊天。 |
| Admin BFF | FastAPI、strawberry-graphql（可选） | 通过 Strawberry 生成 GraphQL schema，vibe 得以智能补全后台查询。 |
| user-svc | FastAPI、SQLModel、aioboto3 | 事件/接口文档同文件存放，支持 vibe 单文件上下文。 |
| auth-svc | FastAPI、passlib、python-jose | OTP/JWT 脚本化命令 `poetry run scripts/issue_token.py` 供 vibe 调度。 |
| risk-svc | FastAPI、pandas、rule-engine | 规则以 YAML + pytest cases 存放，可由 vibe 按需编辑重跑。 |
| loan-svc | FastAPI、SQLModel、Jinja2 | 状态机 DSL（YAML）在 repo 内，vibe 修改后自动生成 diagram。 |
| payment-svc | FastAPI、httpx、Celery | 通道 stub 以内置 mock server（python -m uvicorn mocks.payment）提供，vibe 易演示。 |
| ledger-svc | FastAPI、SQLAlchemy、decimal | `ledger_notebook.ipynb` 示例供 vibe 检查账平。 |
| notify-svc | FastAPI、Celery | 模板/变量在 JSON Schema 描述，方便自动生成提示。 |
| collection-svc | FastAPI、SQLAlchemy | Workbench API 加 WebSocket stub，vibe 可直接模拟坐席。 |
| channel-svc | FastAPI、ClickHouse-driver | 归因脚本（Python notebook）生成渠道报表 demo。 |
| report-svc | FastAPI、SQLModel、airflow-client | `reports_daily.py` 既是 ETL 也是 CLI，可在 vibe 直接运行。 |
| p2p-svc（二期） | FastAPI | 继承相同 scaffolding，保留 stub 供后续 vibe 任务复用。 |

### 2.3 基础设施与工程
- 容器/部署：所有服务提供 OCI 镜像（多阶段 Dockerfile，`poetry export`），通过 Helm/ArgoCD 上线；本地 `docker compose up api-gateway` 即可跑通整链，同时生成 `.vibe-env`，让 vibe coding 直接附着容器。
- 配置管理：Dynaconf/Env 文件 + Vault 存储密钥；Pydantic Settings 注入，并自动生成 `settings.sample.md`，方便 vibe 识别可配置项。
- 数据治理：DBT/SQLMesh + Great Expectations 输出 Markdown 报表；Airflow DAG 描述文件紧邻 Python 代码，便于 vibe 自动补充任务。
- 可观测性：OpenTelemetry Python SDK + Prometheus instrumentation；日志使用 `structlog` 输出 JSON 并带 prompt-friendly 摘要字段。

### 2.4 DX/Vibe 约束
- Mono-repo + `apps/<svc>` 目录结构，每个服务自带 `README.vibe.md`（启动、Mock、示例）。
- 统一 `Taskfile.yml`（或 `justfile`）封装 `task test-auth`, `task lint`, `task run-loan`; vibe coding 直接执行 Task 即可完成开发循环。
- 自动生成示例：每个接口/事件旁放置 `.sample.json` 与 `.http`；CI 保证示例与 Pydantic schema 同步。
- 提供 `devcontainers` 配置（Python 3.12 + uv + Docker CLI），vibe coding 可以在云端一键加载。
- ChatOps：PR robot 使用 `github-comment-bot` 输出可直接复制到 vibe 的调试命令/日志。

### 2.5 事件与数据契约
- 事件命名：`USER_REGISTERED`, `KYC_VERIFIED`, `LOAN_APPLIED`, `RISK_DECIDED`, `LOAN_APPROVED`, `DISBURSED`, `REPAYMENT_POSTED`, `CASE_CREATED`, `CASE_STATUS_CHANGED`, `METRICS_DAILY_READY`。
- 事件格式：Pydantic BaseModel + CloudEvents Envelope，统一 `trace_id`、`timestamp`、`payload_version`，通过 Karapace schema registry 管控。
- 数据同步：loan-svc/payment-svc 写入 Postgres，Debezium CDC 推送到 ClickHouse，report-svc 以 Python ETL 聚合，BFF 缓存在 Redis。

## 3. 领域模型（核心聚合）
| 聚合 | 关键字段 | 存储/实现 | 关联关系 & 事件 |
| --- | --- | --- | --- |
| `User` | userId, phone, country, deviceFingerprint[], consentRecords | Postgres `users` 表 + SQLAlchemy ORM | 1:N LoanApplication；创建/更新触发 `USER_REGISTERED` |
| `KycProfile` | kycId, docType, docNumber, ocrResult(jsonb), livenessScore, reviewer | Postgres `kyc_profiles` + MinIO 文件 | 状态变化推送 `KYC_SUBMITTED/KYC_VERIFIED` |
| `RiskDecision` | decisionId, score, rulesHit[], ttl, inputsHash | ClickHouse `risk_decisions` | 关联 LoanApplication，回写原因；用于风控回溯 |
| `LoanProduct` | productId, amountRange, termOptions, feeConfig(Decimal), currency | Postgres `loan_products` + Redis 缓存 | mobile/admin 查询产品配置 |
| `LoanApplication` | loanId, userId, productId, status(enum), requestedAmount, approvedAmount, dueDates[], contractUri | Postgres `loan_applications` | 状态机驱动 `LOAN_APPLIED/APPROVED/DISBURSED/REPAID` |
| `PaymentInstruction` | paymentId, type(disburse/repay), channel, account, amount, status | Postgres `payment_instructions` | 与 LoanApplication 1:1/1:N；回调→事件 |
| `LedgerEntry` | entryId, refType, refId, lines[{account,debit,credit,currency,tz}] | Postgres `ledger_entries` + JSON lines | 校验借贷平衡；向 report-svc 暴露对账视图 |
| `CollectionCase` | caseId, loanId, bucket, assignee, actions[], ptp | Postgres `collection_cases` | 逾期触发 `CASE_CREATED`；动作写 `CASE_ACTION_LOG` |
| `NotificationTask` | taskId, channel, template, audience, payload, status | Postgres `notify_tasks` + Celery 队列 | 发送完成写 `NOTIFY_SENT` 事件 |
| `ChannelAttribution` | installId, channel, campaign, cost, conversion | ClickHouse `channel_attribution` | 供渠道漏斗分析；反哺 user profile |
| `AuditEvent` | eventId, actor, action, resource, diff, ip, timestamp | Loki + Postgres summary | 所有 BFF/服务写入，满足合规 |

## 4. 关键流程与状态机
### 4.1 贷款生命周期（Python FSM 实现）
`DRAFT → SUBMITTED → AUTO_CHECKING → {AUTO_REJECTED | AUTO_APPROVED} → {MANUAL_REVIEW | SKIP_MANUAL} → {MANUAL_REJECTED | APPROVED} → CONTRACT_PENDING → CONTRACT_SIGNED → DISBURSE_PENDING → {DISBURSED | DISBURSE_FAILED} → ACTIVE → {DUE_TODAY → OVERDUE_BUCKET(n)} → {REPAID | WRITE_OFF}`  
- 利用 python-transitions 或自研装饰器封装状态机，所有状态迁移写审计事件并持久化在 `loan_application_status_history`。
- Manual steps 可配置关闭；幂等通过 loanId + `X-Idempotency-Key` + Redis token bucket 实现。
- 关键校验：审批通过前校验 `RiskDecision.ttl` 未过期；合同签署后才允许放款。

### 4.2 放款流程（异步回调链路）
1. loan-svc 通过 Celery 任务向 payment-svc 发布 `CreateDisbursementCommand`，写入 `payment_instructions`。
2. payment-svc 使用 httpx 调用通道（幂等 header + RSA 签名），在 Redis 记录 `req_no`。
3. 通道回调到 `/callbacks/{channel}` → FastAPI endpoint 校验签名 → 发布 `DISBURSED` Kafka 事件。
4. ledger-svc 消费事件，写入双分录（cash credit / loan_principal debit），校验 Decimal 精度并输出 `ledger_balance{refId}` 指标。
5. loan-svc 更新状态为 `DISBURSED`，触发 notify-svc 发送成功通知，并写入报表。

### 4.3 还款 & 催收流程
1. 借款人主动还款/自动代扣 → payment-svc 写 `payment_instructions`，回调成功后发送 `REPAYMENT_POSTED`。
2. ledger-svc 将款项映射到本金/利息/费用账户，生成 `ledger_entries`，并通过 SQLAlchemy 触发器校验借贷平衡。
3. loan-svc 更新账单 schedule，若全部结清则状态转为 `REPAID`，否则更新 `due_amount`。
4. 若 `due_date + grace_period < now`，loan-svc 发布 `OVERDUE_BUCKET_CHANGED`，collection-svc 建案 -> 分案（Python 匹配算法根据团队负载/逾期天数），动作通过 FastAPI WebSocket 推送给催收工作台。
5. notify-svc 根据 case 状态自动发送提醒，模板采用 Jinja2 + Babel（多语言/货币格式）。
6. report-svc 消费 `CASE_*`、`REPAYMENT_POSTED` 事件，使用 Python ETL 写入 ClickHouse，供日指标查询。

## 5. 非功能要求（Vibe Coding 优化点）
- 安全：FastAPI dependency 注入多重校验；Authlib OAuth2 Server 与 vibe snippet 同步，便于生成一键 curl；PII 字段通过 Fernet/KMS 加密，`pydantic.SecretStr` 避免日志泄露。
- 审计：自定义 FastAPI Middleware 将请求上下文写入 Loki & Postgres `audit_log`，一并生成 `audit_event.sample.json`，供 vibe 重放链路。
- 权限：Casbin policy（YAML）在 admin BFF 热加载，并暴露 GraphQL introspection，vibe 可以根据角色自动补全接口。
- 幂等：Redis + Lua 实现幂等 token；SQLAlchemy 乐观锁避免重复写入；Celery 任务使用 task idempotency key，并在调度输出“复制按钮”方便 vibe 复跑。
- 精度：统一 `Decimal(18,4)`，Pydantic `condecimal` 控制；FX 转换由 Python `decimal` 保证，同时暴露 `fx.sample.md` 用于 QA/vibe 校验。
- 时区/货币：所有时间存 UTC，展示层使用 Pendulum/Babel；`timezone_contract.md` 描述转换规则，vibe 可直接引用。
- 合规：日志保留 ≥5 年，自动归档到 S3；`scripts/export_audit.py` 供 vibe 命令面板调用；合规模块先 stub（mock response + TODO 标记）。
- 观测：启用 `prometheus-fastapi-instrumentator` + OpenTelemetry；生成 `observability.md`，列出关键指标、告警与 `kubectl`/`task` 命令，方便 vibe 触发验证。

## 6. 假设（详见《开放问题与假设.md》）
- A1：一期放款由平台自有资金完成，P2P 出借端二期上线。
- A2：默认首发市场加纳，系统时间线使用 UTC+0，币种 `GHS`；其他币种通过配置扩展。
- A3：支付与代扣统一通过已签约的 REST 支付聚合器，OAuth2 Client Credentials 鉴权，支持 sandbox。
- A4：前后端交互统一通过双 FastAPI BFF，BFF 负责聚合、Role 校验、审计。
- A5：OTP 供应商提供 5 分钟有效期、速率限制 3 次/15 分钟，并支持签名模板。
- A6：对象存储基于 S3/MinIO，所有 KYC 文件加密并附加审计标签。
- A7：ClickHouse 作为指标主存储，Postgres 物化视图仅作 fallback；Airflow 晚间任务窗口 <15 分钟。
